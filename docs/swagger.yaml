openapi: 3.0.0
servers:
  - description: SwaggerHub API Auto Mocking
    url: "/api"
info:
  version: "2.0.0"
  title: Jomon API
  description: >-
    JomonのAPIです。
tags:
  - name: "Auth"
    description: "認証用API"
  - name: "Applications"
    description: "申請に関するAPI"
  - name: "Files"
    description: "ファイルに関するAPI"
  - name: "Tags"
    description: "タグに関するAPI"
  - name: "Users"
    description: "ユーザーに関するAPI"
  - name: "Partitions"
    description: "パーティションに関するAPI"
  - name: "AccountManagers"
    description: "accountManager用API"

##### Paths #####

paths:
  /auth/genpkce:
    get:
      operationId: generatePKCE
      description: PKCEを取得する｡
      tags:
        - Auth
      responses:
        "302":
          description: 取得できた場合｡traQのoauthページにリダイレクトされる。

  /applications:
    get:
      operationId: getApplications
      description: 申請一覧を取得する。
      tags:
        - Applications
      parameters:
        - $ref: "#/components/parameters/sortApplicationQuery"
        - $ref: "#/components/parameters/statusQuery"
        - $ref: "#/components/parameters/targetQuery"
        - $ref: "#/components/parameters/sinceQuery"
        - $ref: "#/components/parameters/untilQuery"
        - $ref: "#/components/parameters/limitQuery"
        - $ref: "#/components/parameters/offsetQuery"
        - $ref: "#/components/parameters/tagQuery"
        - $ref: "#/components/parameters/partitionQuery"
        - $ref: "#/components/parameters/createdByQuery"
      responses:
        "200":
          description: 取得できた場合。該当するものがなくても空配列を返す。
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Application"
        "400":
          $ref: "#/components/responses/400"
    post:
      operationId: postApplication
      description: 申請を新規作成する。
      tags:
        - Applications
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ApplicationRequest"
      responses:
        "201":
          description: 作成できた場合。作成された申請の詳細を返す。
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApplicationDetail"
        "400":
          $ref: "#/components/responses/400"

  /applications/{applicationID}:
    parameters:
      - name: applicationID
        in: path
        required: true
        schema:
          type: string
          format: uuid
    get:
      operationId: getApplicationDetail
      description: 指定した申請の詳細を取得する。
      tags:
        - Applications
      responses:
        "200":
          description: あったら返す。
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApplicationDetail"
        "404":
          $ref: "#/components/responses/404"
    put:
      operationId: putApplicationDetail
      description: 指定した申請を修正する。作成者権限が必要。
      tags:
        - Applications
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ApplicationRequest"
      responses:
        "200":
          description: 修正できた場合。修正後の詳細を返す。
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApplicationDetail"
        "400":
          $ref: "#/components/responses/400"
        "403":
          $ref: "#/components/responses/403"
        "404":
          $ref: "#/components/responses/404"

  /applications/{applicationID}/comments:
    post:
      operationId: postComment
      description: 指定した申請にコメントを新規作成する。
      tags:
        - Applications
      parameters:
        - name: applicationID
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CommentRequest"
      responses:
        "201":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Comment"
        "400":
          $ref: "#/components/responses/400"
        "404":
          $ref: "#/components/responses/404"
  /applications/{applicationID}/status:
    put:
      operationId: putStatus
      description: 指定した申請のstatusを変更のみ(新規はpost /applications)する。commentは常に必須(ないときは空文字列)。statusの変更は、作成者は"change_requested -> submitted"のみが可能、accountManagerはpayment_finishedを除く任意の状態間で可能。ただしapprovedからの変更は、すでに支払われている人がいた場合不可。payment_finishedへの変更は全ての支払い対象者への支払いが完了した場合に自動で行われる。
      tags:
        - Applications
      parameters:
        - name: applicationID
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/StatusRequest"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/StatusDetail"
        "400":
          $ref: "#/components/responses/400"
        "404":
          $ref: "#/components/responses/404"

  /account-managers:
    get:
      operationId: getAccountManagers
      description: accountManagerユーザーの一覧を返す。accountManager権限が必要。
      tags:
        - AccountManagers
      responses:
        "200":
          description: 取得に成功した場合。
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/UserID"
        "400":
          $ref: "#/components/responses/400"
        "403":
          $ref: "#/components/responses/403"
    post:
      operationId: postAccountManagers
      description: accountManagerユーザーを追加する。accountManager権限が必要。
      tags:
        - AccountManagers
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: array
              items:
                $ref: "#/components/schemas/UserID"
      responses:
        "200":
          description: 追加に成功した場合。
        "400":
          $ref: "#/components/responses/400"
        "403":
          $ref: "#/components/responses/403"
    delete:
      operationId: deleteAccountManagers
      description: accountManagerユーザーを削除する。accountManager権限が必要。
      tags:
        - AccountManagers
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: array
              items:
                $ref: "#/components/schemas/UserID"
      responses:
        "200":
          description: 削除できた場合。
        "400":
          $ref: "#/components/responses/400"
        "403":
          $ref: "#/components/responses/403"
        "404":
          $ref: "#/components/responses/404"

  /tags:
    get:
      operationId: getTags
      description: タグの一覧を返す。
      tags:
        - Tags
      responses:
        "200":
          description: 取得に成功した場合。
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Tag"
    post:
      operationId: postTag
      description: タグを追加する。
      tags:
        - Tags
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/TagRequest"
      responses:
        "200":
          description: 追加に成功した場合。追加されたタグの情報を返す。
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Tag"
        "400":
          $ref: "#/components/responses/400"

  /tags/{tagID}:
    parameters:
      - name: tagID
        in: path
        required: true
        schema:
          type: string
          format: uuid
    put:
      operationId: putTag
      description: タグの情報を変更する。accountManager権限が必要。
      tags:
        - Tags
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/TagRequest"
      responses:
        "200":
          description: 変更に成功した場合。
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Tag"
        "400":
          $ref: "#/components/responses/400"
        "403":
          $ref: "#/components/responses/403"
        "404":
          $ref: "#/components/responses/404"
    delete:
      description: タグを削除する
      tags:
        - Tags
      responses:
        "200":
          description: 削除に成功した場合。
        "404":
          $ref: "#/components/responses/404"

  /partitions:
    get:
      operationId: getPartitions
      description: パーティションの一覧を返す。
      tags:
        - Partitions
      responses:
        "200":
          description: 取得に成功した場合。
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Partition"
    post:
      operationId: postPartition
      description: パーティションを追加する。accountManager権限が必要。
      tags:
        - Partitions
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/PartitionRequest"
      responses:
        "200":
          description: 追加に成功した場合。
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Partition"
        "400":
          $ref: "#/components/responses/400"
        "403":
          $ref: "#/components/responses/403"

  /partitions/{partitionID}:
    parameters:
      - name: partitionID
        in: path
        required: true
        schema:
          type: string
          format: uuid
    get:
      operationId: getPartition
      description: パーティションの情報を返す。
      tags:
        - Partitions
      responses:
        "200":
          description: 取得に成功した場合。
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Partition"
        "404":
          $ref: "#/components/responses/404"
    put:
      operationId: putPartition
      description: パーティションの情報を変更する。accountManager権限が必要。
      tags:
        - Partitions
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/PartitionRequest"
      responses:
        "200":
          description: 変更に成功した場合。
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Partition"
        "400":
          $ref: "#/components/responses/400"
        "403":
          $ref: "#/components/responses/403"
        "404":
          $ref: "#/components/responses/404"
    delete:
      operationId: deletePartition
      description: パーティションを削除する。accountManager権限が必要。
      tags:
        - Partitions
      responses:
        "200":
          description: 削除に成功した場合
        "403":
          $ref: "#/components/responses/403"
        "404":
          $ref: "#/components/responses/404"

  /partition-groups:
    get:
      operationId: getPartitionGroups
      description: パーティショングループの一覧を返す。
      tags:
        - Partitions
      responses:
        "200":
          description: 取得に成功した場合。
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/PartitionGroup"
    post:
      operationId: postPartitionGroup
      description: パーティショングループを追加する。accountManager権限が必要。
      tags:
        - Partitions
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/PartitionGroupRequest"
      responses:
        "200":
          description: 追加に成功した場合。
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PartitionGroup"
        "400":
          $ref: "#/components/responses/400"
        "403":
          $ref: "#/components/responses/403"

  /partition-groups/{partitionGroupID}:
    parameters:
      - name: partitionGroupID
        in: path
        required: true
        schema:
          type: string
          format: uuid
    get:
      operationId: getPartitionGroup
      description: パーティショングループの情報を返す。
      tags:
        - Partitions
      responses:
        "200":
          description: 取得に成功した場合。
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PartitionGroup"
        "404":
          $ref: "#/components/responses/404"
    put:
      operationId: putPartitionGroup
      description: パーティショングループの情報を変更する。accountManager権限が必要。
      tags:
        - Partitions
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/PartitionGroupRequest"
      responses:
        "200":
          description: 変更に成功した場合。
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PartitionGroup"
        "400":
          $ref: "#/components/responses/400"
        "403":
          $ref: "#/components/responses/403"
        "404":
          $ref: "#/components/responses/404"
    delete:
      operationId: deletePartitionGroup
      description: パーティショングループを削除する。accountManager権限が必要。
      tags:
        - Partitions
      responses:
        "200":
          description: 削除に成功した場合
        "403":
          $ref: "#/components/responses/403"
        "404":
          $ref: "#/components/responses/404"

  /files:
    post:
      operationId: postFile
      description: ファイルをアップロードする。
      tags:
        - Files
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              $ref: "#/components/schemas/FileRequest"
      responses:
        "200":
          description: 変更に成功した場合。
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: string
                    format: uuid
        "400":
          $ref: "#/components/responses/400"
  /files/{fileID}:
    parameters:
      - name: fileID
        in: path
        required: true
        schema:
          type: string
          format: uuid
    get:
      operationId: getFile
      tags:
        - Files
      description: 指定されたファイルを返す
      responses:
        "200":
          description: 該当するファイルが存在した 返す
          content:
            application/octet-stream:
              schema:
                type: string
                format: binary
        "400":
          $ref: "#/components/responses/400"
        "404":
          $ref: "#/components/responses/404"
        "304":
          $ref: "#/components/responses/304"
        "500":
          $ref: "#/components/responses/500"
    delete:
      operationId: deleteFile
      description: 指定したidのファイルを削除する。accountManager権限または作成者権限が必要。
      tags:
        - Files
      responses:
        "204":
          description: 正常に取り消すことができた場合。
        "400":
          $ref: "#/components/responses/400"
        "403":
          $ref: "#/components/responses/403"
        "404":
          $ref: "#/components/responses/404"
        "500":
          $ref: "#/components/responses/500"
  "/files/{fileID}/meta":
    parameters:
      - name: fileID
        in: path
        required: true
        schema:
          type: string
          format: uuid
    get:
      tags:
        - Files
      operationId: getFileMeta
      description: 指定されたファイルのメタデータを返す
      responses:
        "200":
          description: 該当するファイルのメタデータが存在した 返す
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/FileMeta"
        "400":
          $ref: "#/components/responses/400"
        "404":
          $ref: "#/components/responses/404"
        "500":
          $ref: "#/components/responses/500"

  /users:
    get:
      operationId: getUsers
      description: "ユーザー一覧を取得する。"
      tags:
        - "Users"
      responses:
        "200":
          description: "OK"
          content:
            application/json:
              schema:
                type: "array"
                items:
                  $ref: "#/components/schemas/User"

  /users/me:
    get:
      operationId: getMe
      description: "自分の情報を取得する。存在しない場合はユーザーを作成する。"
      tags:
        - "Users"
      responses:
        "200":
          description: "取得に成功した場合。"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/User"

##### Components #####

components:
  schemas:
    AuthInfo:
      type: object
      properties:
        code_challenge:
          type: string
        code_challenge_method:
          type: string
        client_id:
          type: string
        response_type:
          type: string
    StatusEnum:
      type: string
      enum: [submitted, change_requested, approved, payment_finished, rejected]
    UserID:
      type: string
      format: uuid
    Tag:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
          example: "2020講習会"
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
      required:
        - id
        - name
        - created_at
        - updated_at
    TagRequest:
      type: object
      properties:
        name:
          type: string
          example: "2020講習会"
      required:
        - name
    Partition:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
          example: "SysAd班予算"
        budget:
          type: integer
          nullable: true
          example: 250000
        management:
          $ref: "#/components/schemas/PartitionManagement"
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
      required:
        - id
        - name
        - budget
        - management
        - created_at
        - updated_at
    PartitionRequest:
      type: object
      properties:
        name:
          type: string
          example: "SysAd班予算"
        budget:
          type: integer
          nullable: true
          example: 250000
        management:
          $ref: "#/components/schemas/PartitionManagement"
      required:
        - name
        - budget
        - management
    PartitionGroup:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
          example: "イベント運営経費"
        child_partitions:
          type: array
          items:
            $ref: "#/components/schemas/Partition"
        child_partition_groups:
          type: array
          items:
            $ref: "#/components/schemas/PartitionGroup"
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
      required:
        - id
        - name
        - child_partitions
        - child_partition_groups
        - created_at
        - updated_at
    PartitionGroupRequest:
      type: object
      properties:
        name:
          type: string
          example: "イベント運営経費"
        child_partitions:
          type: array
          items:
            type: string
            format: uuid
        child_partition_groups:
          type: array
          items:
            type: string
            format: uuid
      required:
        - name
        - child_partitions
        - child_partition_groups
    PartitionManagement:
      type: object
      required:
        - category
        - state
      properties:
        category:
          type: string
          description: 管理カテゴリ
          enum:
            - "manual"
          example: "manual"
        state:
          type: string
          description: パーティションの利用可能状態
          enum:
            - "available"
            - "unavailable"
    ApplicationFile:
      type: object
      properties:
        file:
          type: string
          format: binary
        name:
          type: string
          example: "hoge.png"
      required:
        - file
        - name
    FileRequest:
      type: object
      properties:
        file:
          type: string
          format: binary
        name:
          type: string
          example: "hoge.png"
        application_id:
          type: string
          format: uuid
      required:
        - file
        - name
        - application_id
    FileMeta:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        mime_type:
          type: string
        created_at:
          type: string
          format: date-time
      required:
        - id
        - name
        - mime_type
        - created_at
    ApplicationTargetRequest:
      type: object
      properties:
        amount:
          type: integer
          example: 1200
        target:
          type: string
          format: uuid
      required:
        - amount
        - target
    ApplicationTarget:
      type: object
      properties:
        id:
          type: string
          format: uuid
        amount:
          type: integer
        target:
          type: string
          format: uuid
        paid_at:
          type: string
          nullable: true
          format: date-time
        created_at:
          type: string
          format: date-time
      required:
        - id
        - amount
        - target
        - paid_at
        - created_at
    Application:
      type: object
      properties:
        id:
          type: string
          format: uuid
        status:
          $ref: "#/components/schemas/StatusEnum"
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
        created_by:
          $ref: "#/components/schemas/UserID"
        title:
          type: string
          example: "SysAd講習会の開催費用"
        content:
          type: string
          example: "サーバー代 1200円"
        targets:
          type: array
          items:
            $ref: "#/components/schemas/ApplicationTarget"
        tags:
          type: array
          items:
            $ref: "#/components/schemas/Tag"
        partition:
          $ref: "#/components/schemas/Partition"
      required:
        - id
        - status
        - created_at
        - updated_at
        - created_by
        - title
        - content
        - targets
        - tags
        - partition
    ApplicationDetail:
      type: object
      properties:
        id:
          type: string
          format: uuid
        status:
          $ref: "#/components/schemas/StatusEnum"
        title:
          type: string
          example: "SysAd講習会の開催費用"
        content:
          type: string
          example: "サーバー代 1200円"
        created_by:
          type: string
          format: uuid
        comments:
          type: array
          items:
            $ref: "#/components/schemas/Comment"
        files:
          type: array
          items:
            type: string
            format: uuid
        statuses:
          type: array
          items:
            $ref: "#/components/schemas/Status"
        tags:
          type: array
          items:
            $ref: "#/components/schemas/Tag"
        partition:
          $ref: "#/components/schemas/Partition"
        targets:
          type: array
          items:
            $ref: "#/components/schemas/ApplicationTarget"
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
      required:
        - id
        - status
        - title
        - content
        - created_by
        - comments
        - files
        - statuses
        - tags
        - partition
        - targets
        - created_at
        - updated_at
    ApplicationRequest:
      type: object
      properties:
        created_by:
          $ref: "#/components/schemas/UserID"
        title:
          type: string
          example: "SysAd講習会の開催費用"
        content:
          type: string
          example: "サーバー代 1200円"
        tags:
          type: array
          items:
            type: string
            format: uuid
        partition:
          type: string
          format: uuid
        targets:
          type: array
          items:
            $ref: "#/components/schemas/ApplicationTargetRequest"
      required:
        - title
        - content
        - created_by
        - tags
        - partition
        - targets
    Comment:
      type: object
      properties:
        id:
          type: string
          format: uuid
        user:
          $ref: "#/components/schemas/UserID"
        comment:
          type: string
          example: "コメント内容"
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
      required:
        - id
        - user
        - comment
        - created_at
        - updated_at
    CommentRequest:
      type: object
      properties:
        comment:
          type: string
          example: "ここを修正してください。"
      required:
        - comment
    Status:
      type: object
      properties:
        created_by:
          $ref: "#/components/schemas/UserID"
        status:
          $ref: "#/components/schemas/StatusEnum"
        created_at:
          type: string
          format: date-time
      required:
        - created_by
        - status
        - created_at
    StatusDetail:
      type: object
      properties:
        created_by:
          $ref: "#/components/schemas/UserID"
        status:
          $ref: "#/components/schemas/StatusEnum"
        comment:
          $ref: "#/components/schemas/Comment"
        created_at:
          type: string
          format: date-time
      required:
        - created_by
        - status
        - created_at
    StatusRequest:
      type: object
      properties:
        status:
          $ref: "#/components/schemas/StatusEnum"
        comment:
          type: string
          example: "良いですね。"
      required:
        - status
        - comment
    User:
      type: "object"
      properties:
        id:
          $ref: "#/components/schemas/UserID"
        name:
          type: string
          example: "nagatech"
        display_name:
          type: string
          example: "ながてち"
        account_manager:
          type: boolean
        created_at:
          type: string
          format: "date-time"
        updated_at:
          type: string
          format: "date-time"
        deleted_at:
          type: string
          nullable: true
          format: "date-time"
      required:
        - id
        - name
        - display_name
        - account_manager
        - created_at
        - updated_at
        - deleted_at
  responses:
    304:
      description: Not Modified
    400:
      description: 不正なリクエスト。
    403:
      description: 編集権限がない人による操作。
    404:
      description: 指定したリソースは存在しない。
    500:
      description: サーバーエラー。

  parameters:
    sortApplicationQuery:
      name: sort
      description: 並び順 (作成日時が新しい "created_at", 作成日時が古い "-created_at", タイトルの昇順 "title", タイトルの降順 "-title")
      required: false
      in: query
      schema:
        type: string
    statusQuery:
      name: status
      description: 現在の状態
      required: false
      in: query
      schema:
        $ref: "#/components/schemas/StatusEnum"
    targetQuery:
      name: target
      description: 誰との取引か
      required: false
      in: query
      schema:
        type: string
        format: uuid
    sinceQuery:
      name: since
      description: いつからの依頼か
      required: false
      in: query
      schema:
        type: string
        format: date
    untilQuery:
      name: until
      description: いつまでの依頼か
      required: false
      in: query
      schema:
        type: string
        format: date
    limitQuery:
      name: limit
      description: 取得する最大個数
      required: false
      in: query
      schema:
        type: integer
        minimum: 0
        default: 100
    offsetQuery:
      name: offset
      description: スキップする個数
      required: false
      in: query
      schema:
        type: integer
        minimum: 0
        default: 0
    tagQuery:
      name: tag
      description: タグ(複数の場合カンマ区切り)
      required: false
      in: query
      schema:
        type: string
    partitionQuery:
      name: partition
      description: パーティション
      required: false
      in: query
      schema:
        type: string
    createdByQuery:
      name: created_by
      description: 作成者
      required: false
      in: query
      schema:
        type: string
        format: uuid
